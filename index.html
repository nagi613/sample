from flask import Flask, request, render_template_string
from PIL import Image
import torch

app = Flask(__name__)

# ãƒ©ãƒ™ãƒ«ã¨ã‚«ãƒ†ã‚´ãƒªã®å¯¾å¿œ
label_to_category = {
    "bottle": "è³‡æºã‚´ãƒŸï¼ˆãƒšãƒƒãƒˆãƒœãƒˆãƒ«ï¼‰ğŸ§´", "can": "è³‡æºã‚´ãƒŸï¼ˆç¼¶ï¼‰ğŸ¥«",
    "cup": "ç‡ƒãˆã‚‹ã‚´ãƒŸï¼ˆç´™ã‚³ãƒƒãƒ—ï¼‰â˜•", "banana": "ç‡ƒãˆã‚‹ã‚´ãƒŸï¼ˆç”Ÿã‚´ãƒŸï¼‰ğŸŒ",
    "apple": "ç‡ƒãˆã‚‹ã‚´ãƒŸï¼ˆç”Ÿã‚´ãƒŸï¼‰ğŸ", "orange": "ç‡ƒãˆã‚‹ã‚´ãƒŸï¼ˆç”Ÿã‚´ãƒŸï¼‰ğŸŠ",
    "broccoli": "ç‡ƒãˆã‚‹ã‚´ãƒŸï¼ˆé‡èœï¼‰ğŸ¥¦", "carrot": "ç‡ƒãˆã‚‹ã‚´ãƒŸï¼ˆé‡èœï¼‰ğŸ¥•",
    "pizza": "ç‡ƒãˆã‚‹ã‚´ãƒŸï¼ˆé£Ÿã¹æ®‹ã—ï¼‰ğŸ•", "cake": "ç‡ƒãˆã‚‹ã‚´ãƒŸï¼ˆé£Ÿã¹æ®‹ã—ï¼‰ğŸ°",
    "laptop": "ç‡ƒãˆãªã„ã‚´ãƒŸï¼ˆé›»å­æ©Ÿå™¨ï¼‰ğŸ’»", "cell phone": "ç‡ƒãˆãªã„ã‚´ãƒŸï¼ˆãƒãƒƒãƒ†ãƒªãƒ¼ï¼‰ğŸ“±",
    "tv": "ç‡ƒãˆãªã„ã‚´ãƒŸï¼ˆãƒ†ãƒ¬ãƒ“ï¼‰ğŸ“º", "microwave": "ç‡ƒãˆãªã„ã‚´ãƒŸï¼ˆé›»å­ãƒ¬ãƒ³ã‚¸ï¼‰ğŸ”¥",
    "vase": "ç‡ƒãˆãªã„ã‚´ãƒŸï¼ˆé™¶å™¨ï¼‰ğŸº", "book": "è³‡æºã‚´ãƒŸï¼ˆç´™é¡ï¼‰ğŸ“š",
    "newspaper": "è³‡æºã‚´ãƒŸï¼ˆæ–°èç´™ï¼‰ğŸ—ï¸", "toilet paper": "è³‡æºã‚´ãƒŸï¼ˆç´™é¡ï¼‰ğŸ§»",
    "dining table": "ç²—å¤§ã”ã¿ï¼ˆå®¶å…·ï¼‰ğŸ›‹ï¸", "chair": "ç²—å¤§ã”ã¿ï¼ˆæ¤…å­ï¼‰ğŸª‘",
    "bed": "ç²—å¤§ã”ã¿ï¼ˆãƒ™ãƒƒãƒ‰ï¼‰ğŸ›ï¸", "person": "åˆ†åˆ¥ä¸å¯ï¼ˆäººé–“ï¼‰ğŸš«",
    "handbag": "ç‡ƒãˆãªã„ã‚´ãƒŸï¼ˆé©ãƒ»å¸ƒï¼‰ğŸ‘œ", "shoe": "ç‡ƒãˆã‚‹ã‚´ãƒŸï¼ˆé´ï¼‰ğŸ‘",
    "backpack": "ç‡ƒãˆã‚‹ã‚´ãƒŸï¼ˆå¸ƒé¡ï¼‰ğŸ’", "clock": "ç‡ƒãˆãªã„ã‚´ãƒŸï¼ˆæ©Ÿæ¢°ï¼‰â°",
    "umbrella": "ç‡ƒãˆãªã„ã‚´ãƒŸï¼ˆå‚˜ï¼‰ğŸŒ‚", "scissors": "ç‡ƒãˆãªã„ã‚´ãƒŸï¼ˆé‡‘å±ï¼‰âœ‚ï¸",
    "toothbrush": "ç‡ƒãˆãªã„ã‚´ãƒŸï¼ˆãƒ—ãƒ©ã‚¹ãƒãƒƒã‚¯ï¼‰ğŸª¥"
}

# YOLOv5 ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿
model = torch.hub.load('ultralytics/yolov5', 'yolov5n', source='github')

# HTMLãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
HTML_TEMPLATE = """
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ã‚´ãƒŸåˆ†åˆ¥AI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .container { max-width: 600px; margin-top: 50px; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .result-label { font-weight: bold; }
        .badge { font-size: 1rem; }
    </style>
</head>
<body>
<div class="container">
    <h2 class="text-center mb-4">â™»ï¸ ã‚´ãƒŸåˆ†åˆ¥AI</h2>
    <p class="text-center">ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ã€AIã§ã‚´ãƒŸã®ç¨®é¡ã‚’åˆ¤åˆ¥ã—ã‚ˆã†ï¼</p>

    <form method="POST" enctype="multipart/form-data">
        <input type="file" name="file" accept="image/*" class="form-control mb-3" required>
        <button type="submit" class="btn btn-success w-100">AIã§åˆ¤åˆ¥</button>
    </form>

    {% if result %}
    <div class="mt-4">
        <h4>ğŸ§  åˆ†åˆ¥çµæœ</h4>
        <ul class="list-group">
            {% for label, conf, category in result %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
                <span><span class="result-label">{{ label }}</span>ï¼ˆä¿¡é ¼åº¦: {{ '%.2f'|format(conf) }}ï¼‰</span>
                <span class="badge bg-primary">{{ category }}</span>
            </li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}
</div>
</body>
</html>
"""

@app.route("/", methods=["GET", "POST"])
def index():
    result = None
    if request.method == "POST":
        file = request.files.get("file")
        if file:
            img = Image.open(file.stream)
            results = model(img)
            df = results.pandas().xyxy[0]
            result = []
            for _, row in df.iterrows():
                label = row["name"]
                conf = row["confidence"]
                category = label_to_category.get(label, "âš ï¸ æœªåˆ†é¡ã®ã‚´ãƒŸï¼ˆæ‰‹å‹•ã§ç¢ºèªã—ã¦ãã ã•ã„ï¼‰")
                result.append((label, conf, category))
    return render_template_string(HTML_TEMPLATE, result=result)

if __name__ == "__main__":
    app.run(debug=True)
